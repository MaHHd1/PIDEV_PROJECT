{# changer_password.html.twig #}
{% extends 'enseignant/prof_base.html.twig' %}

{% block title %}Changer le Mot de Passe - Enseignant{% endblock %}

{% block additional_styles %}
    <style>
        .password-strength {
            height: 5px;
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        .strength-weak { background-color: #dc3545; width: 25%; }
        .strength-fair { background-color: #ffc107; width: 50%; }
        .strength-good { background-color: #17a2b8; width: 75%; }
        .strength-strong { background-color: #28a745; width: 100%; }
    </style>
{% endblock %}

{% block page_title %}Changer le Mot de Passe{% endblock %}

{% block page_subtitle %}Mettez à jour votre mot de passe de sécurité{% endblock %}

{% block page_actions %}
    <a href="{{ path('app_enseignant_dashboard') }}" class="btn btn-outline-primary mb-0 me-2">
        <i class="fas fa-arrow-left me-1"></i>Retour au dashboard
    </a>
{% endblock %}

{% block main_content %}
    <!-- Password change form START -->
    <div class="card border bg-transparent rounded-3">
        <div class="card-header bg-transparent border-bottom">
            <h3 class="mb-0">Modification du mot de passe</h3>
        </div>

        <div class="card-body">
            {% for flash in app.flashes('success') %}
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="fas fa-check-circle me-2"></i>{{ flash }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}

            {% for flash in app.flashes('error') %}
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="fas fa-exclamation-circle me-2"></i>{{ flash }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}

            {{ form_start(form, {'attr': {'id': 'passwordForm', 'novalidate': 'novalidate'}}) }}
            <div class="row g-4">
                <!-- Current Password -->
                <div class="col-12">
                    <label for="{{ form.currentPassword.vars.id }}" class="form-label">Mot de passe actuel *</label>
                    <div class="input-group">
                        {{ form_widget(form.currentPassword, {'attr': {
                            'class': 'form-control' ~ (form.currentPassword.vars.errors|length ? ' is-invalid' : ''),
                        }}) }}
                        <button class="btn btn-outline-secondary" type="button" id="toggleCurrentPassword">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    {% if form.currentPassword.vars.errors|length %}
                        <div class="form-error text-danger mt-1">
                            {{ form_errors(form.currentPassword) }}
                        </div>
                    {% endif %}
                    <div class="form-text">
                        Saisissez votre mot de passe actuel pour vérification.
                    </div>
                </div>

                <!-- New Password -->
                <div class="col-md-6">
                    <label for="{{ form.newPassword.first.vars.id }}" class="form-label">Nouveau mot de passe *</label>
                    <div class="input-group">
                        {{ form_widget(form.newPassword.first, {'attr': {
                            'class': 'form-control' ~ (form.newPassword.first.vars.errors|length ? ' is-invalid' : ''),
                        }}) }}
                        <button class="btn btn-outline-secondary" type="button" id="toggleNewPassword">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>

                    <!-- Password strength indicator -->
                    <div class="mt-2">
                        <div class="d-flex justify-content-between mb-1">
                            <small>Force du mot de passe:</small>
                            <small id="strengthText">Faible</small>
                        </div>
                        <div class="progress" style="height: 5px;">
                            <div class="progress-bar" id="passwordStrength"
                                 role="progressbar" style="width: 25%; background-color: #dc3545;"></div>
                        </div>
                    </div>

                    <!-- Password requirements -->
                    <div class="form-text mt-2">
                        Le mot de passe doit contenir:
                        <ul class="mb-0">
                            <li id="reqLength">Au moins 8 caractères</li>
                            <li id="reqUppercase">Une lettre majuscule</li>
                            <li id="reqLowercase">Une lettre minuscule</li>
                            <li id="reqNumber">Un chiffre</li>
                        </ul>
                    </div>

                    {% if form.newPassword.first.vars.errors|length %}
                        <div class="form-error text-danger mt-1">
                            {{ form_errors(form.newPassword.first) }}
                        </div>
                    {% endif %}
                </div>

                <!-- Confirm Password -->
                <div class="col-md-6">
                    <label for="{{ form.newPassword.second.vars.id }}" class="form-label">Confirmer le mot de passe *</label>
                    <div class="input-group">
                        {{ form_widget(form.newPassword.second, {'attr': {
                            'class': 'form-control' ~ (form.newPassword.second.vars.errors|length ? ' is-invalid' : ''),
                        }}) }}
                        <button class="btn btn-outline-secondary" type="button" id="toggleConfirmPassword">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    <div class="form-text">
                        Ressaisissez le nouveau mot de passe pour confirmation.
                    </div>
                    <div class="mt-2" id="passwordMatch" style="display: none;">
                        <small class="text-success">
                            <i class="fas fa-check-circle me-1"></i>Les mots de passe correspondent
                        </small>
                    </div>
                    <div class="mt-2" id="passwordMismatch" style="display: none;">
                        <small class="text-danger">
                            <i class="fas fa-times-circle me-1"></i>Les mots de passe ne correspondent pas
                        </small>
                    </div>

                    {% if form.newPassword.second.vars.errors|length %}
                        <div class="form-error text-danger mt-1">
                            {{ form_errors(form.newPassword.second) }}
                        </div>
                    {% endif %}
                </div>

                <!-- Security Tips -->
                <div class="col-12">
                    <div class="alert alert-info">
                        <h6 class="alert-heading">
                            <i class="fas fa-shield-alt me-2"></i>Conseils de sécurité
                        </h6>
                        <ul class="mb-0">
                            <li>Utilisez un mot de passe unique que vous n'utilisez nulle part ailleurs</li>
                            <li>Évitez les informations personnelles (nom, date de naissance, etc.)</li>
                            <li>Changez votre mot de passe régulièrement</li>
                            <li>Ne partagez jamais votre mot de passe avec qui que ce soit</li>
                        </ul>
                    </div>
                </div>

                <!-- Form buttons -->
                <div class="col-12 mt-4">
                    <div class="d-flex justify-content-between">
                        <a href="{{ path('app_enseignant_dashboard') }}" class="btn btn-secondary">
                            Annuler
                        </a>
                        <button type="submit" class="btn btn-primary" id="submitBtn">
                            <i class="fas fa-key me-2"></i>Changer le mot de passe
                        </button>
                    </div>
                </div>
            </div>
            {{ form_end(form) }}
        </div>
    </div>
    <!-- Password change form END -->

    <!-- Last Password Change -->
    <div class="card border bg-transparent rounded-3 mt-4">
        <div class="card-header bg-transparent border-bottom">
            <h3 class="mb-0">Historique de sécurité</h3>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <ul class="list-group list-group-borderless">
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Dernière connexion</span>
                            <span class="fw-bold">
                            {% if enseignant.lastLogin %}
                                {{ enseignant.lastLogin|date('d/m/Y H:i') }}
                            {% else %}
                                Non disponible
                            {% endif %}
                        </span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Compte créé le</span>
                            <span class="fw-bold">{{ enseignant.dateCreation|date('d/m/Y') }}</span>
                        </li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <ul class="list-group list-group-borderless">
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Statut du compte</span>
                            <span class="badge bg-success">Actif</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Session actuelle</span>
                            <span class="fw-bold">En cours</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block additional_javascripts %}
    <script>
        // Toggle password visibility
        function togglePasswordVisibility(inputId, buttonId) {
            const button = document.getElementById(buttonId);
            const input = document.getElementById(inputId);

            if (button && input) {
                button.addEventListener('click', function() {
                    const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
                    input.setAttribute('type', type);
                    this.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
                });
            }
        }

        // Initialize password toggles
        togglePasswordVisibility('{{ form.currentPassword.vars.id }}', 'toggleCurrentPassword');
        togglePasswordVisibility('{{ form.newPassword.first.vars.id }}', 'toggleNewPassword');
        togglePasswordVisibility('{{ form.newPassword.second.vars.id }}', 'toggleConfirmPassword');

        // Password strength checker
        function checkPasswordStrength(password) {
            let strength = 0;
            const requirements = {
                length: password.length >= 8,
                uppercase: /[A-Z]/.test(password),
                lowercase: /[a-z]/.test(password),
                number: /[0-9]/.test(password),
                special: /[^A-Za-z0-9]/.test(password)
            };

            // Update requirement indicators
            const reqLength = document.getElementById('reqLength');
            const reqUppercase = document.getElementById('reqUppercase');
            const reqLowercase = document.getElementById('reqLowercase');
            const reqNumber = document.getElementById('reqNumber');

            if (reqLength) reqLength.style.color = requirements.length ? '#28a745' : '#dc3545';
            if (reqUppercase) reqUppercase.style.color = requirements.uppercase ? '#28a745' : '#dc3545';
            if (reqLowercase) reqLowercase.style.color = requirements.lowercase ? '#28a745' : '#dc3545';
            if (reqNumber) reqNumber.style.color = requirements.number ? '#28a745' : '#dc3545';

            // Calculate strength
            if (requirements.length) strength++;
            if (requirements.uppercase) strength++;
            if (requirements.lowercase) strength++;
            if (requirements.number) strength++;
            if (requirements.special) strength++;

            // Update strength indicator
            const strengthBar = document.getElementById('passwordStrength');
            const strengthText = document.getElementById('strengthText');

            if (strengthBar && strengthText) {
                switch(strength) {
                    case 0:
                    case 1:
                        strengthBar.style.width = '25%';
                        strengthBar.style.backgroundColor = '#dc3545';
                        strengthText.textContent = 'Très faible';
                        strengthText.style.color = '#dc3545';
                        break;
                    case 2:
                        strengthBar.style.width = '50%';
                        strengthBar.style.backgroundColor = '#ffc107';
                        strengthText.textContent = 'Faible';
                        strengthText.style.color = '#ffc107';
                        break;
                    case 3:
                        strengthBar.style.width = '75%';
                        strengthBar.style.backgroundColor = '#17a2b8';
                        strengthText.textContent = 'Moyen';
                        strengthText.style.color = '#17a2b8';
                        break;
                    case 4:
                    case 5:
                        strengthBar.style.width = '100%';
                        strengthBar.style.backgroundColor = '#28a745';
                        strengthText.textContent = 'Fort';
                        strengthText.style.color = '#28a745';
                        break;
                }
            }

            return strength >= 3; // Minimum 3 requirements met
        }

        // Password match checker
        function checkPasswordMatch() {
            const newPassword = document.getElementById('{{ form.newPassword.first.vars.id }}');
            const confirmPassword = document.getElementById('{{ form.newPassword.second.vars.id }}');
            const matchElement = document.getElementById('passwordMatch');
            const mismatchElement = document.getElementById('passwordMismatch');

            if (!newPassword || !confirmPassword) return false;

            if (confirmPassword.value === '') {
                if (matchElement) matchElement.style.display = 'none';
                if (mismatchElement) mismatchElement.style.display = 'none';
                return false;
            }

            if (newPassword.value === confirmPassword.value) {
                if (matchElement) matchElement.style.display = 'block';
                if (mismatchElement) mismatchElement.style.display = 'none';
                return true;
            } else {
                if (matchElement) matchElement.style.display = 'none';
                if (mismatchElement) mismatchElement.style.display = 'block';
                return false;
            }
        }

        // Form validation
        function validateForm() {
            const currentPassword = document.getElementById('{{ form.currentPassword.vars.id }}');
            const newPassword = document.getElementById('{{ form.newPassword.first.vars.id }}');
            const confirmPassword = document.getElementById('{{ form.newPassword.second.vars.id }}');
            const submitBtn = document.getElementById('submitBtn');

            if (!currentPassword || !newPassword || !confirmPassword || !submitBtn) return;

            const isStrong = checkPasswordStrength(newPassword.value);
            const isMatch = checkPasswordMatch();

            // Visual feedback only, don't disable submit button
            // Server-side validation will handle it
        }

        // Event listeners
        const newPasswordInput = document.getElementById('{{ form.newPassword.first.vars.id }}');
        const confirmPasswordInput = document.getElementById('{{ form.newPassword.second.vars.id }}');
        const currentPasswordInput = document.getElementById('{{ form.currentPassword.vars.id }}');

        if (newPasswordInput) newPasswordInput.addEventListener('input', validateForm);
        if (confirmPasswordInput) confirmPasswordInput.addEventListener('input', validateForm);
        if (currentPasswordInput) currentPasswordInput.addEventListener('input', validateForm);

        // Initial validation
        validateForm();
    </script>
{% endblock %}
