{% extends 'admin/admin_base.html.twig' %}

{% block title %}Administration — Cours du Module{% endblock %}

{% block admin_content %}
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h1 class="h3 mb-0">{{ module.titreModule }}</h1>
        <p class="text-muted mb-0">{{ module.description }}</p>
      </div>
      <div class="d-flex gap-2">
        <a href="{{ path('app_admin_cours_new') }}" class="btn btn-primary">Ajouter un Cours</a>
        <a href="{{ path('app_admin_module_edit', {'id': module.id}) }}" class="btn btn-outline-primary">Modifier Module</a>
        <a href="{{ path('app_admin_modules_list') }}" class="btn btn-outline-secondary">Retour aux Modules</a>
      </div>
    </div>

    <div class="card shadow-sm">
      <div class="card-header">
        <h5 class="mb-0">Cours de ce module ({{ courses|length }})</h5>
      </div>
      <div class="card-body">
        <form method="get" class="row g-2 align-items-end mb-3">
          <div class="col-md-5">
            <label class="form-label mb-1">Recherche</label>
            <input
              type="text"
              name="q"
              class="form-control"
              placeholder="Titre, code, description..."
              value="{{ filters.q|default('') }}"
            >
          </div>
          <div class="col-md-3">
            <label class="form-label mb-1">Statut</label>
            <select name="statut" class="form-select">
              <option value="" {{ (filters.statut|default('')) == '' ? 'selected' : '' }}>Tous</option>
              <option value="ouvert" {{ (filters.statut|default('')) == 'ouvert' ? 'selected' : '' }}>Ouvert</option>
              <option value="brouillon" {{ (filters.statut|default('')) == 'brouillon' ? 'selected' : '' }}>Brouillon</option>
              <option value="ferme" {{ (filters.statut|default('')) == 'ferme' ? 'selected' : '' }}>Ferme</option>
              <option value="archive" {{ (filters.statut|default('')) == 'archive' ? 'selected' : '' }}>Archive</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label mb-1">Tri</label>
            <select name="sort" class="form-select">
              <option value="recent" {{ (filters.sort|default('recent')) == 'recent' ? 'selected' : '' }}>Recents</option>
              <option value="title_desc" {{ (filters.sort|default('recent')) == 'title_desc' ? 'selected' : '' }}>Titre Z-A</option>
            </select>
          </div>
          <div class="col-md-2 d-flex gap-2">
            <button class="btn btn-primary w-100">Filtrer</button>
            <a href="{{ path('app_admin_module_courses', {'id': module.id}) }}" class="btn btn-outline-secondary">Reset</a>
          </div>
        </form>

        {% if courses|length > 0 %}
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th>Code</th>
                  <th>Titre</th>
                  <th>Enseignants</th>
                  <th>Statut</th>
                  <th class="text-end">Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for cours in courses %}
                  <tr>
                    <td><code>{{ cours.codeCours }}</code></td>
                    <td><strong>{{ cours.titre }}</strong></td>
                    <td>
                      {% if cours.enseignants|length > 0 %}
                        {% for ens in cours.enseignants %}
                          {{ ens.prenom ~ ' ' ~ ens.nom }}{% if not loop.last %}, {% endif %}
                        {% endfor %}
                      {% else %}
                        —
                      {% endif %}
                    </td>
                    <td>
                      <span class="badge {{ cours.statut == 'ouvert' ? 'bg-success' : (cours.statut == 'brouillon' ? 'bg-secondary' : 'bg-dark') }}">
                        {{ cours.statut }}
                      </span>
                    </td>
                    <td class="text-end">
                      <a href="{{ path('app_admin_cours_show', {'id': cours.id}) }}" class="btn btn-sm btn-info">Voir détail</a>
                      <a href="{{ path('app_admin_cours_contents', {'id': cours.id}) }}" class="btn btn-sm btn-outline-secondary">Contenus</a>
                      <a href="{{ path('app_admin_cours_edit', {'id': cours.id}) }}" class="btn btn-sm btn-outline-primary">Modifier</a>
                      <form method="post" action="{{ path('app_admin_cours_delete', {'id': cours.id}) }}" style="display:inline" onsubmit="return confirm('Supprimer ce cours ?');">
                        <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ cours.id) }}" />
                        <button class="btn btn-sm btn-danger">Supprimer</button>
                      </form>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% if pagination is defined and pagination.total_pages > 1 %}
            <div class="d-flex justify-content-between align-items-center mt-3">
              <small class="text-muted">Page {{ pagination.current_page }} / {{ pagination.total_pages }}</small>
              <div class="btn-group btn-group-sm">
                {% set prevPage = pagination.current_page > 1 ? pagination.current_page - 1 : 1 %}
                {% set nextPage = pagination.current_page < pagination.total_pages ? pagination.current_page + 1 : pagination.total_pages %}
                <a class="btn btn-outline-secondary {{ pagination.current_page <= 1 ? 'disabled' : '' }}" href="{{ path('app_admin_module_courses', {'id': module.id, 'page': prevPage, 'q': filters.q|default(''), 'statut': filters.statut|default(''), 'sort': filters.sort|default('recent')}) }}">Precedent</a>
                <a class="btn btn-outline-secondary {{ pagination.current_page >= pagination.total_pages ? 'disabled' : '' }}" href="{{ path('app_admin_module_courses', {'id': module.id, 'page': nextPage, 'q': filters.q|default(''), 'statut': filters.statut|default(''), 'sort': filters.sort|default('recent')}) }}">Suivant</a>
              </div>
            </div>
          {% endif %}
        {% else %}
          <p class="text-muted text-center py-4">Aucun cours dans ce module.</p>
        {% endif %}
      </div>
    </div>
  </div>
{% endblock %}
