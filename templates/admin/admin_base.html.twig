{% extends 'base.html.twig' %}

{% block title %}Gestion des Événements - Administration{% endblock %}

{% block body %}
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav id="sidebar" class="col-md-3 col-lg-2 d-md-block bg-dark sidebar collapse">
                <div class="position-sticky pt-3">
                    <!-- Logo -->
                    <div class="sidebar-header text-center mb-4">
                        <a href="#" class="navbar-brand d-flex justify-content-center align-items-center">
                            <img src="{{ asset('assets/images/logo-light.svg') }}" alt="Logo" style="max-height: 40px;">
                        </a>
                    </div>

                    <!-- Profil utilisateur -->
                    <div class="user-info text-center mb-4 p-3 border-bottom border-secondary">
                        <div class="avatar mx-auto mb-3">
                            {% if app.user %}
                                <div class="avatar-img rounded-circle bg-primary text-white d-flex align-items-center justify-content-center mx-auto" style="width: 60px; height: 60px; font-size: 1.5rem;">
                                    {{ app.user.prenom|default('A')|first|upper }}{{ app.user.nom|default('dmin')|first|upper }}
                                </div>
                            {% else %}
                                <div class="avatar-img rounded-circle bg-primary text-white d-flex align-items-center justify-content-center mx-auto" style="width: 60px; height: 60px; font-size: 1.5rem;">
                                    ??
                                </div>
                            {% endif %}
                        </div>
                        <div>
                            {% if app.user %}
                                <h6 class="text-white mb-0">{{ app.user.prenom|default('Admin') }} {{ app.user.nom|default('') }}</h6>
                                <small class="text-white-50">Administrateur</small>
                                <br>
                                <small class="text-white-50">{{ app.user.email|default('admin@example.com') }}</small>
                            {% else %}
                                <h6 class="text-white mb-0">Non connecté</h6>
                                <small class="text-white-50">Veuillez vous connecter</small>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Menu de navigation -->
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link text-white {% if app.request.attributes.get('_route') == 'app_administrateur_dashboard' %}active bg-primary{% endif %}" href="#">
                                <i class="bi bi-speedometer2 me-2"></i> Dashboard
                            </a>
                        </li>

                        <li class="nav-item">
                            <a class="nav-link text-white {% if app.request.attributes.get('_route') starts with 'app_administrateur_utilisateurs' %}active bg-primary{% endif %}" href="#">
                                <i class="fas fa-users me-2"></i> Utilisateurs
                            </a>
                        </li>

                        <!-- Menu Événements avec sous-menu -->
                        <li class="nav-item">
                            <a class="nav-link text-white {% if app.request.attributes.get('_route') starts with 'app_evenement' %}active bg-primary{% endif %}" 
                               data-bs-toggle="collapse" 
                               href="#evenementsSubmenu" 
                               role="button" 
                               aria-expanded="{{ app.request.attributes.get('_route') starts with 'app_evenement' ? 'true' : 'false' }}">
                                <i class="bi bi-calendar-event me-2"></i> Événements
                                <i class="bi bi-chevron-down float-end"></i>
                            </a>
                            <div class="collapse {% if app.request.attributes.get('_route') starts with 'app_evenement' %}show{% endif %}" id="evenementsSubmenu">
                                <ul class="nav flex-column ms-3">
                                    <li class="nav-item">
                                        <a class="nav-link text-white {% if app.request.attributes.get('_route') == 'app_evenement_index' %}active bg-primary{% endif %}" 
                                           href="{{ path('app_evenement_index') }}">
                                            <i class="bi bi-list-ul me-2"></i> Liste
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link text-white {% if app.request.attributes.get('_route') == 'app_evenement_new' %}active bg-primary{% endif %}" 
                                           href="{{ path('app_evenement_new') }}">
                                            <i class="bi bi-plus-circle me-2"></i> Nouveau
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link text-white {% if app.request.attributes.get('_route') == 'app_evenement_calendar' %}active bg-primary{% endif %}" 
                                           href="#">
                                            <i class="bi bi-calendar-week me-2"></i> Calendrier
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link text-white {% if app.request.attributes.get('_route') == 'app_evenement_statistics' %}active bg-primary{% endif %}" 
                                           href="#">
                                            <i class="bi bi-bar-chart me-2"></i> Statistiques
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </li>

                        <!-- Menu Participations -->
                        <li class="nav-item">
                            <a class="nav-link text-white {% if app.request.attributes.get('_route') starts with 'app_participation_evenement' %}active bg-primary{% endif %}" 
                               href="{{ path('app_participation_evenement_index') }}">
                                <i class="bi bi-ticket-perforated me-2"></i> Participations
                            </a>
                        </li>

                        <!-- Menu Ajouter Utilisateur avec sous-menu -->
                        <li class="nav-item">
                            <a class="nav-link text-white" 
                               data-bs-toggle="collapse" 
                               href="#addUserSubmenu" 
                               role="button" 
                               aria-expanded="false">
                                <i class="bi bi-person-plus me-2"></i> Ajouter Utilisateur
                                <i class="bi bi-chevron-down float-end"></i>
                            </a>
                            <div class="collapse" id="addUserSubmenu">
                                <ul class="nav flex-column ms-3">
                                    <li class="nav-item">
                                        <a class="nav-link text-white" href="#">
                                            <i class="bi bi-person-vcard me-2"></i> Étudiant
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link text-white" href="#">
                                            <i class="bi bi-person-badge me-2"></i> Enseignant
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link text-white" href="#">
                                            <i class="bi bi-shield-check me-2"></i> Administrateur
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </li>

                        <!-- Statistiques -->
                        <li class="nav-item">
                            <a class="nav-link text-white {% if app.request.attributes.get('_route') == 'app_administrateur_statistiques' %}active bg-primary{% endif %}" 
                               href="#">
                                <i class="bi bi-graph-up me-2"></i> Statistiques
                            </a>
                        </li>

                        <!-- Profil -->
                        <li class="nav-item">
                            <a class="nav-link text-white {% if app.request.attributes.get('_route') == 'app_administrateur_profile' %}active bg-primary{% endif %}" 
                               href="#">
                                <i class="bi bi-person-circle me-2"></i> Mon Profil
                            </a>
                        </li>

                        <!-- Déconnexion -->
                        <li class="nav-item mt-4">
                            <a class="nav-link text-danger" href="#">
                                <i class="bi bi-power me-2"></i> Déconnexion
                            </a>
                        </li>
                    </ul>

                    <!-- Footer sidebar -->
                    <div class="sidebar-footer mt-4 text-center">
                        <a href="#" class="text-white-50 small">
                            <i class="bi bi-house-door me-1"></i> Site public
                        </a>
                    </div>
                </div>
            </nav>

            <!-- Contenu principal -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <!-- Barre de navigation supérieure -->
                <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom py-3">
                    <div class="container-fluid">
                        <!-- Bouton pour ouvrir/fermer la sidebar sur mobile -->
                        <button class="navbar-toggler d-md-none me-3" type="button" data-bs-toggle="collapse" data-bs-target="#sidebar" aria-controls="sidebar" aria-expanded="false" aria-label="Toggle navigation">
                            <i class="bi bi-list"></i>
                        </button>

                        <!-- Recherche -->
                        <form class="d-flex flex-grow-1 me-4" action="{{ path('app_evenement_index') }}" method="get">
                            <div class="input-group">
                                <input class="form-control border-end-0 border" 
                                       type="search" 
                                       name="search" 
                                       placeholder="Rechercher un événement..." 
                                       aria-label="Search"
                                       value="{{ app.request.query.get('search') }}">
                                <button class="btn btn-outline-primary border-start-0 border" type="submit">
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                        </form>

                        <!-- Menu utilisateur -->
                        <div class="dropdown">
                            <a href="#" class="d-flex align-items-center text-decoration-none dropdown-toggle" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                {% if app.user %}
                                    <div class="avatar avatar-sm me-2">
                                        <div class="avatar-img rounded-circle bg-primary text-white d-flex align-items-center justify-content-center">
                                            {{ app.user.prenom|default('A')|first|upper }}{{ app.user.nom|default('dmin')|first|upper }}
                                        </div>
                                    </div>
                                    <span class="text-dark">{{ app.user.prenom|default('Admin') }}</span>
                                {% else %}
                                    <span class="text-dark">Compte</span>
                                {% endif %}
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end shadow" aria-labelledby="userDropdown">
                                <li>
                                    <a class="dropdown-item" href="#">
                                        <i class="bi bi-person me-2"></i> Profil
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="#">
                                        <i class="bi bi-speedometer2 me-2"></i> Dashboard
                                    </a>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <a class="dropdown-item text-danger" href="#">
                                        <i class="bi bi-power me-2"></i> Déconnexion
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </nav>

                <!-- Contenu de la page -->
                <div class="py-4">
                    <!-- En-tête de page -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h1 class="h3 mb-0">Gestion des Événements</h1>
                            <p class="text-muted mb-0">Liste de tous les événements du système</p>
                        </div>
                        <div class="btn-group">
                            <a href="{{ path('app_evenement_new') }}" class="btn btn-primary">
                                <i class="bi bi-plus-lg me-1"></i> Nouvel événement
                            </a>
                            <button type="button" class="btn btn-primary dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown">
                                <span class="visually-hidden">Options</span>
                            </button>
                            <ul class="dropdown-menu">
                                <li>
                                    <a class="dropdown-item" href="#">
                                        <i class="bi bi-calendar-week me-2"></i> Vue calendrier
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="#">
                                        <i class="bi bi-bar-chart me-2"></i> Statistiques
                                    </a>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <a class="dropdown-item" href="{{ path('app_evenement_export_csv') }}">
                                        <i class="bi bi-download me-2"></i> Exporter CSV
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="#">
                                        <i class="bi bi-upload me-2"></i> Importer
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <!-- Filtres rapides -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-body">
                            <form method="get" class="row g-3">
                                <div class="col-md-3">
                                    <label class="form-label">Type</label>
                                    <select class="form-select" name="type">
                                        <option value="">Tous les types</option>
                                        <option value="webinaire" {{ app.request.query.get('type') == 'webinaire' ? 'selected' : '' }}>Webinaire</option>
                                        <option value="examen" {{ app.request.query.get('type') == 'examen' ? 'selected' : '' }}>Examen</option>
                                        <option value="reunion" {{ app.request.query.get('type') == 'reunion' ? 'selected' : '' }}>Réunion</option>
                                        <option value="atelier" {{ app.request.query.get('type') == 'atelier' ? 'selected' : '' }}>Atelier</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Statut</label>
                                    <select class="form-select" name="statut">
                                        <option value="">Tous les statuts</option>
                                        <option value="planifie" {{ app.request.query.get('statut') == 'planifie' ? 'selected' : '' }}>Planifié</option>
                                        <option value="en_cours" {{ app.request.query.get('statut') == 'en_cours' ? 'selected' : '' }}>En cours</option>
                                        <option value="termine" {{ app.request.query.get('statut') == 'termine' ? 'selected' : '' }}>Terminé</option>
                                        <option value="annule" {{ app.request.query.get('statut') == 'annule' ? 'selected' : '' }}>Annulé</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Visibilité</label>
                                    <select class="form-select" name="visibilite">
                                        <option value="">Toutes</option>
                                        <option value="public" {{ app.request.query.get('visibilite') == 'public' ? 'selected' : '' }}>Public</option>
                                        <option value="prive" {{ app.request.query.get('visibilite') == 'prive' ? 'selected' : '' }}>Privé</option>
                                        <option value="par_invitation" {{ app.request.query.get('visibilite') == 'par_invitation' ? 'selected' : '' }}>Par invitation</option>
                                    </select>
                                </div>
                                <div class="col-md-3 d-flex align-items-end">
                                    <div class="d-flex gap-2 w-100">
                                        <button type="submit" class="btn btn-primary flex-grow-1">
                                            <i class="bi bi-funnel me-1"></i> Filtrer
                                        </button>
                                        <a href="{{ path('app_evenement_index') }}" class="btn btn-outline-secondary">
                                            <i class="bi bi-x-lg"></i>
                                        </a>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Tableau des événements -->
                    <div class="card shadow">
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th class="ps-4">ID</th>
                                            <th>Titre</th>
                                            <th>Type</th>
                                            <th>Date début</th>
                                            <th>Date fin</th>
                                            <th>Lieu</th>
                                            <th>Capacité</th>
                                            <th>Statut</th>
                                            <th>Visibilité</th>
                                            <th>Créateur</th>
                                            <th class="text-end pe-4">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for evenement in evenements %}
                                            <tr>
                                                <td class="ps-4 fw-bold text-muted">#{{ evenement.id }}</td>
                                                <td>
                                                    <strong>{{ evenement.titre }}</strong>
                                                    {% if evenement.description %}
                                                        <br>
                                                        <small class="text-muted">{{ evenement.description|slice(0, 50) }}{{ evenement.description|length > 50 ? '...' : '' }}</small>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <span class="badge bg-info">
                                                        {{ evenement.typeEvenement.value|capitalize }}
                                                    </span>
                                                </td>
                                                <td>
                                                    <small class="d-block">{{ evenement.dateDebut ? evenement.dateDebut|date('d/m/Y') : '' }}</small>
                                                    <small class="text-muted">{{ evenement.dateDebut ? evenement.dateDebut|date('H:i') : '' }}</small>
                                                </td>
                                                <td>
                                                    <small class="d-block">{{ evenement.dateFin ? evenement.dateFin|date('d/m/Y') : '' }}</small>
                                                    <small class="text-muted">{{ evenement.dateFin ? evenement.dateFin|date('H:i') : '' }}</small>
                                                </td>
                                                <td>{{ evenement.lieu|default('-') }}</td>
                                                <td>
                                                    <span class="badge bg-secondary">{{ evenement.capaciteMax|default('-') }}</span>
                                                </td>
                                                <td>
                                                    <span class="badge 
                                                        {% if evenement.statut.value == 'planifie' %}bg-warning
                                                        {% elseif evenement.statut.value == 'en_cours' %}bg-primary
                                                        {% elseif evenement.statut.value == 'termine' %}bg-success
                                                        {% elseif evenement.statut.value == 'annule' %}bg-danger
                                                        {% else %}bg-secondary{% endif %}">
                                                        {{ evenement.statut.value|capitalize }}
                                                    </span>
                                                </td>
                                                <td>
                                                    <span class="badge 
                                                        {% if evenement.visibilite.value == 'public' %}bg-success
                                                        {% elseif evenement.visibilite.value == 'prive' %}bg-secondary
                                                        {% elseif evenement.visibilite.value == 'par_invitation' %}bg-primary
                                                        {% else %}bg-light text-dark{% endif %}">
                                                        {{ evenement.visibilite.value|replace({'_': ' '})|capitalize }}
                                                    </span>
                                                </td>
                                                <td>
                                                    <small>{{ evenement.createur ? evenement.createur.email : 'Anonyme' }}</small>
                                                </td>
                                                <td class="text-end pe-4">
                                                    <div class="btn-group btn-group-sm" role="group">
                                                        <a href="{{ path('app_evenement_show', {'id': evenement.id}) }}" 
                                                           class="btn btn-outline-info" title="Voir">
                                                            <i class="bi bi-eye"></i>
                                                        </a>
                                                        <a href="{{ path('app_evenement_edit', {'id': evenement.id}) }}" 
                                                           class="btn btn-outline-primary" title="Modifier">
                                                            <i class="bi bi-pencil"></i>
                                                        </a>
                                                        <form method="post" 
                                                              action="{{ path('app_evenement_delete', {'id': evenement.id}) }}" 
                                                              class="d-inline">
                                                            <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ evenement.id) }}">
                                                            <button type="submit" 
                                                                    class="btn btn-outline-danger" 
                                                                    title="Supprimer"
                                                                    onclick="return confirm('Supprimer cet événement ?')">
                                                                <i class="bi bi-trash"></i>
                                                            </button>
                                                        </form>
                                                    </div>
                                                </td>
                                            </tr>
                                        {% else %}
                                            <tr>
                                                <td colspan="11" class="text-center py-4">
                                                    <div class="py-3">
                                                        <i class="bi bi-calendar-x fs-1 text-muted"></i>
                                                        <h5 class="mt-2 text-muted">Aucun événement trouvé</h5>
                                                        <p class="text-muted">Commencez par créer votre premier événement</p>
                                                        <a href="{{ path('app_evenement_new') }}" class="btn btn-primary">
                                                            <i class="bi bi-plus-lg me-1"></i> Créer un événement
                                                        </a>
                                                    </div>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        {% if evenements|length > 0 %}
                            <div class="card-footer bg-white border-top">
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">
                                        Affichage de {{ evenements|length }} événement(s)
                                    </small>
                                    <!-- Pagination (optionnel) -->
                                    <nav>
                                        <ul class="pagination pagination-sm mb-0">
                                            <li class="page-item disabled">
                                                <span class="page-link">Précédent</span>
                                            </li>
                                            <li class="page-item active">
                                                <span class="page-link">1</span>
                                            </li>
                                            <li class="page-item">
                                                <a class="page-link" href="#">2</a>
                                            </li>
                                            <li class="page-item">
                                                <a class="page-link" href="#">3</a>
                                            </li>
                                            <li class="page-item">
                                                <a class="page-link" href="#">Suivant</a>
                                            </li>
                                        </ul>
                                    </nav>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </main>
        </div>
    </div>

    <style>
        /* Styles pour la sidebar */
        #sidebar {
            min-height: 100vh;
            background-color: #212529;
        }
        
        #sidebar .nav-link {
            color: #adb5bd;
            padding: 0.75rem 1rem;
            border-radius: 0.375rem;
            margin: 0.125rem 0.5rem;
        }
        
        #sidebar .nav-link:hover {
            color: #fff;
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        #sidebar .nav-link.active {
            color: #fff;
            background-color: #0d6efd;
        }
        
        #sidebar .nav-link.text-danger:hover {
            background-color: rgba(220, 53, 69, 0.1);
        }
        
        /* Styles pour le contenu principal */
        .sidebar {
            position: fixed;
            top: 0;
            bottom: 0;
            left: 0;
            z-index: 100;
            padding: 48px 0 0;
            box-shadow: inset -1px 0 0 rgba(0, 0, 0, .1);
        }
        
        @media (max-width: 767.98px) {
            .sidebar {
                position: static;
                padding-top: 0;
            }
            
            main {
                padding-left: 0 !important;
            }
        }
        
        /* Styles pour la table */
        .table td, .table th {
            vertical-align: middle;
        }
        
        .badge {
            font-size: 0.8em;
            padding: 0.35em 0.65em;
        }
        
        .btn-group .btn {
            border-radius: 4px;
        }
        
        .avatar-img {
            font-size: 0.9rem;
        }
    </style>

    <script>
        // Gestion de la sidebar sur mobile
        document.addEventListener('DOMContentLoaded', function() {
            // Toggle de la sidebar
            const sidebarToggler = document.querySelector('[data-bs-target="#sidebar"]');
            if (sidebarToggler) {
                sidebarToggler.addEventListener('click', function() {
                    const sidebar = document.getElementById('sidebar');
                    sidebar.classList.toggle('show');
                });
            }
            
            // Fermer la sidebar quand on clique à l'extérieur sur mobile
            document.addEventListener('click', function(event) {
                const sidebar = document.getElementById('sidebar');
                const isMobile = window.innerWidth < 768;
                
                if (isMobile && sidebar.classList.contains('show') && 
                    !sidebar.contains(event.target) && 
                    !event.target.closest('[data-bs-target="#sidebar"]')) {
                    sidebar.classList.remove('show');
                }
            });
            
            // Auto-submit des filtres
            document.querySelectorAll('select[name="type"], select[name="statut"], select[name="visibilite"]').forEach(function(select) {
                select.addEventListener('change', function() {
                    this.form.submit();
                });
            });
            
            // Tooltips
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        });
    </script>
{% endblock %}