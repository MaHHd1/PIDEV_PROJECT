{% extends 'base.html.twig' %}
{% block title %}{{ forum.titre }}{% endblock %}

{% block body %}
<div class="d-flex justify-content-between align-items-center">
  <div>
    <h3 class="mb-1">
    ğŸ’¬ {{ forum.titre }}
    {% if forum.estModifie %}
        <span class="badge text-bg-warning ms-2">modifiÃ©</span>
    {% endif %}
    </h3>
    {% if forum.estModifie and forum.dateModification %}
    <div class="text-muted">DerniÃ¨re modification : {{ forum.dateModification|date('Y-m-d H:i') }}</div>
    {% endif %}
    <div class="text-muted">
      CrÃ©Ã© par {{ forum.createur.username }}
      â€¢ Vues {{ forum.nombreVues }}
      â€¢ Type {{ forum.type }}
      â€¢ Statut {{ forum.statut }}
      â€¢ ğŸ‘ {{ forum.likes ?? 0 }} â€¢ ğŸ‘ {{ forum.dislikes ?? 0 }} â€¢ ğŸš© {{ forum.signalements ?? 0 }}
    </div>
  </div>

  <div class="d-flex gap-2">
    <a class="btn btn-outline-secondary" href="{{ path('forum_edit', {id: forum.id, u: activeUser.id}) }}">âœï¸ Modifier</a>
    <a class="btn btn-outline-dark" href="{{ path('forum_list', {u: activeUser.id}) }}">â† Liste</a>
  </div>
</div>

<hr>

{% if forum.imageCouvertureUrl %}
  {% set img = forum.imageCouvertureUrl|trim %}
  {% if img starts with 'www.' %}
    {% set img = 'https://' ~ img %}
  {% endif %}

  <div class="mb-3">
    <a href="{{ img }}" target="_blank" rel="noopener noreferrer">
      <img class="img-fluid rounded border" style="max-height:260px; object-fit:cover;" src="{{ img }}" alt="cover">
    </a>
  </div>
{% endif %}

<p>{{ forum.description|nl2br }}</p>

{% if forum.reglesModeration %}
  <div class="alert alert-warning">
    <b>RÃ¨gles de modÃ©ration:</b><br>
    {{ forum.reglesModeration|nl2br }}
  </div>
{% endif %}

<div class="d-flex flex-wrap gap-2 mb-3">
  <a class="btn btn-primary" href="{{ path('comment_new', {forumId: forum.id, u: activeUser.id}) }}">+ Ajouter un commentaire</a>

  <form method="post" action="{{ path('forum_like', {id: forum.id, u: activeUser.id}) }}">
    <button class="btn btn-outline-success">ğŸ‘ Like forum</button>
  </form>

  <form method="post" action="{{ path('forum_dislike', {id: forum.id, u: activeUser.id}) }}">
    <button class="btn btn-outline-danger">ğŸ‘ Dislike forum</button>
  </form>

  <form method="post" action="{{ path('forum_report', {id: forum.id, u: activeUser.id}) }}">
    <button class="btn btn-outline-warning">ğŸš© Report forum</button>
  </form>

  <form method="post" action="{{ path('forum_delete', {id: forum.id, u: activeUser.id}) }}"
        onsubmit="return confirm('Supprimer ce forum ?');">
    <button class="btn btn-outline-secondary">ğŸ—‘ Delete forum</button>
  </form>
</div>

<h4 class="mt-4">ğŸ—¨ï¸ Posts & commentaires ({{ comments|length }})</h4>

{% if comments is empty %}
  <div class="alert alert-info">Aucun commentaire.</div>
{% else %}
  {% for c in comments %}
    {% set indent = c.parent ? 40 : 0 %}
    <div class="card shadow-sm mb-2" style="margin-left: {{ indent }}px;">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <b>{{ c.utilisateur.username }}</b>
            <span class="text-muted">â€¢ {{ c.datePublication|date('Y-m-d H:i') }}</span>
            {% if c.statut == 'en_attente' %}
              <span class="badge text-bg-warning ms-2">en attente</span>
            {% endif %}
          </div>
          <div class="text-muted">
            ğŸ‘ {{ c.likes }} â€¢ ğŸ‘ {{ c.dislikes }} â€¢ ğŸš© {{ c.signalements }} â€¢ rÃ©ponses {{ c.nbReponses }}
          </div>
        </div>

        <div class="mt-2">{{ c.contenu|nl2br }}</div>

        <div class="d-flex gap-2 mt-3">
          <a class="btn btn-sm btn-outline-primary" href="{{ path('comment_reply', {commentId: c.id, u: activeUser.id}) }}">â†© Reply</a>

          <form method="post" action="{{ path('comment_like', {id: c.id, u: activeUser.id}) }}">
            <button class="btn btn-sm btn-outline-success">ğŸ‘ Like</button>
          </form>

          <form method="post" action="{{ path('comment_dislike', {id: c.id, u: activeUser.id}) }}">
            <button class="btn btn-sm btn-outline-danger">ğŸ‘ Dislike</button>
          </form>

          <form method="post" action="{{ path('comment_report', {id: c.id, u: activeUser.id}) }}">
            <button class="btn btn-sm btn-outline-warning">ğŸš© Report</button>
          </form>

          <form method="post" action="{{ path('comment_delete', {id: c.id, u: activeUser.id}) }}">
            <button class="btn btn-sm btn-outline-secondary">ğŸ—‘ Delete</button>
          </form>
        </div>

        {% if c.parent %}
          <div class="text-muted mt-2">â†ª rÃ©ponse Ã  commentaire #{{ c.parent.id }}</div>
        {% endif %}
      </div>
    </div>
  {% endfor %}
{% endif %}
{% endblock %}
