{% extends 'etudiant/student_base.html.twig' %}

{% block title %}Modifier le Profil - Étudiant{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        .avatar-upload {
            position: relative;
            display: inline-block;
        }
        .avatar-upload input[type="file"] {
            display: none;
        }
        .avatar-upload label {
            cursor: pointer;
        }
        .upload-icon {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background: #667eea;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        .form-error {
            color: #dc3545;
            font-size: 0.875em;
            margin-top: 0.25rem;
        }
        .is-invalid {
            border-color: #dc3545;
            padding-right: calc(1.5em + 0.75rem);
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right calc(0.375em + 0.1875rem) center;
            background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
        }
        .is-invalid:focus {
            border-color: #dc3545;
            box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.25);
        }
    </style>
{% endblock %}

{% block banner %}
    <!-- Custom banner for edit profile -->
    <section class="pt-0">
        <div class="container-fluid px-0">
            <div class="card bg-blue h-100px h-md-200px rounded-0" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            </div>
        </div>
        <div class="container mt-n4">
            <div class="row">
                <div class="col-12">
                    <div class="card bg-transparent card-body pb-0 px-0 mt-2 mt-sm-0">
                        <div class="row d-sm-flex justify-sm-content-between mt-2 mt-md-0">
                            <!-- Avatar -->
                            <div class="col-auto">
                                <div class="avatar avatar-xxl position-relative mt-n3 avatar-upload">
                                    <div class="avatar-img rounded-circle border border-white border-3 shadow bg-primary text-white d-flex align-items-center justify-content-center" style="width: 120px; height: 120px; font-size: 3rem;">
                                        {{ student.prenom|first|upper }}{{ student.nom|first|upper }}
                                    </div>
                                    <div class="upload-icon">
                                        <i class="fas fa-camera"></i>
                                    </div>
                                    <input type="file" id="avatarUpload" accept="image/*">
                                    <label for="avatarUpload" class="stretched-link"></label>
                                </div>
                            </div>
                            <!-- Profile info -->
                            <div class="col d-sm-flex justify-content-between align-items-center">
                                <div>
                                    <h1 class="my-1 fs-4">Modifier le Profil</h1>
                                    <p class="mb-0">Mettez à jour vos informations personnelles</p>
                                </div>
                                <!-- Single Button -->
                                <div class="mt-2 mt-sm-0">
                                    <a href="{{ path('app_etudiant_dashboard') }}" class="btn btn-outline-primary mb-0 me-2">
                                        <i class="fas fa-arrow-left me-1"></i>Retour au dashboard
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Advanced filter responsive toggler START -->
                    <hr class="d-xl-none">
                    <div class="col-12 col-xl-3 d-flex justify-content-between align-items-center">
                        <a class="h6 mb-0 fw-bold d-xl-none" href="#">Menu</a>
                        <button class="btn btn-primary d-xl-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasSidebar" aria-controls="offcanvasSidebar">
                            <i class="fas fa-sliders-h"></i>
                        </button>
                    </div>
                    <!-- Advanced filter responsive toggler END -->
                </div>
            </div>
        </div>
    </section>
{% endblock %}

{% block student_content %}
    <!-- Edit profile form START -->
    <div class="card border bg-transparent rounded-3">
        <div class="card-header bg-transparent border-bottom">
            <h3 class="mb-0">Informations personnelles</h3>
        </div>
        <div class="card-body">
            {% for flash in app.flashes('success') %}
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="fas fa-check-circle me-2"></i>{{ flash }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}

            {% for flash in app.flashes('error') %}
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="fas fa-exclamation-circle me-2"></i>{{ flash }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}

            {{ form_start(form, {'attr': {'id': 'editProfileForm', 'method': 'post', 'action': path('app_etudiant_edit_profile'), 'novalidate': 'novalidate'}}) }}
            <div class="row g-4">
                <!-- Personal Information Section -->
                <div class="col-12">
                    <h5 class="mb-3"><i class="fas fa-user me-2"></i>Informations personnelles</h5>
                </div>

                <!-- First Name -->
                <div class="col-md-6">
                    <label for="{{ form.prenom.vars.id }}" class="form-label">Prénom *</label>
                    {{ form_widget(form.prenom, {'attr': {'class': 'form-control' ~ (form.prenom.vars.errors|length ? ' is-invalid' : ''), 'required': 'required'}}) }}
                    {{ form_errors(form.prenom) }}
                    <div class="form-text">Votre prénom tel qu'il apparaît sur vos documents officiels.</div>
                </div>

                <!-- Last Name -->
                <div class="col-md-6">
                    <label for="{{ form.nom.vars.id }}" class="form-label">Nom *</label>
                    {{ form_widget(form.nom, {'attr': {'class': 'form-control' ~ (form.nom.vars.errors|length ? ' is-invalid' : ''), 'required': 'required'}}) }}
                    {{ form_errors(form.nom) }}
                    <div class="form-text">Votre nom de famille.</div>
                </div>

                <!-- Email -->
                <div class="col-md-6">
                    <label for="{{ form.email.vars.id }}" class="form-label">Adresse email *</label>
                    {{ form_widget(form.email, {'attr': {'class': 'form-control' ~ (form.email.vars.errors|length ? ' is-invalid' : ''), 'type': 'email', 'required': 'required'}}) }}
                    {{ form_errors(form.email) }}
                    <div class="form-text">Cette adresse sera utilisée pour la connexion et les notifications.</div>
                </div>

                <!-- Phone -->
                <div class="col-md-6">
                    <label for="{{ form.telephone.vars.id }}" class="form-label">Téléphone</label>
                    {{ form_widget(form.telephone, {'attr': {'class': 'form-control' ~ (form.telephone.vars.errors|length ? ' is-invalid' : ''), 'type': 'tel'}}) }}
                    {{ form_errors(form.telephone) }}
                    <div class="form-text">Numéro de téléphone.</div>
                </div>

                <!-- Password (only for creation, not for edit) -->
                {% if form.motDePasse is defined %}
                    <div class="col-md-6">
                        <label for="{{ form.motDePasse.vars.id }}" class="form-label">Mot de passe</label>
                        {{ form_widget(form.motDePasse, {'attr': {'class': 'form-control' ~ (form.motDePasse.vars.errors|length ? ' is-invalid' : '')}}) }}
                        {{ form_errors(form.motDePasse) }}
                        <div class="form-text">Laissez vide pour ne pas modifier.</div>
                    </div>
                {% endif %}

                <!-- Matricule (if editable) -->
                {% if form.matricule is defined %}
                    <div class="col-md-6">
                        <label for="{{ form.matricule.vars.id }}" class="form-label">Matricule *</label>
                        {{ form_widget(form.matricule, {'attr': {'class': 'form-control' ~ (form.matricule.vars.errors|length ? ' is-invalid' : ''), 'required': 'required'}}) }}
                        {{ form_errors(form.matricule) }}
                    </div>
                {% endif %}

                <!-- Date of Birth -->
                <div class="col-md-6">
                    <label for="{{ form.dateNaissance.vars.id }}" class="form-label">Date de naissance *</label>
                    {{ form_widget(form.dateNaissance, {'attr': {'class': 'form-control' ~ (form.dateNaissance.vars.errors|length ? ' is-invalid' : ''), 'required': 'required'}}) }}
                    {{ form_errors(form.dateNaissance) }}
                </div>

                <!-- Niveau d'étude (if editable) -->
                {% if form.niveauEtude is defined %}
                    <div class="col-md-6">
                        <label for="{{ form.niveauEtude.vars.id }}" class="form-label">Niveau d'étude *</label>
                        {{ form_widget(form.niveauEtude, {'attr': {'class': 'form-select' ~ (form.niveauEtude.vars.errors|length ? ' is-invalid' : ''), 'required': 'required'}}) }}
                        {{ form_errors(form.niveauEtude) }}
                    </div>
                {% endif %}

                <!-- Specialisation (if editable) -->
                {% if form.specialisation is defined %}
                    <div class="col-md-6">
                        <label for="{{ form.specialisation.vars.id }}" class="form-label">Spécialisation *</label>
                        {{ form_widget(form.specialisation, {'attr': {'class': 'form-control' ~ (form.specialisation.vars.errors|length ? ' is-invalid' : ''), 'required': 'required'}}) }}
                        {{ form_errors(form.specialisation) }}
                    </div>
                {% endif %}

                <!-- Address -->
                <div class="col-md-6">
                    <label for="{{ form.adresse.vars.id }}" class="form-label">Adresse *</label>
                    {{ form_widget(form.adresse, {'attr': {'class': 'form-control' ~ (form.adresse.vars.errors|length ? ' is-invalid' : ''), 'rows': 3, 'required': 'required'}}) }}
                    {{ form_errors(form.adresse) }}
                </div>

                <!-- Statut (if editable) -->
                {% if form.statut is defined %}
                    <div class="col-md-6">
                        <label for="{{ form.statut.vars.id }}" class="form-label">Statut *</label>
                        {{ form_widget(form.statut, {'attr': {'class': 'form-select' ~ (form.statut.vars.errors|length ? ' is-invalid' : ''), 'required': 'required'}}) }}
                        {{ form_errors(form.statut) }}
                    </div>
                {% endif %}

                <!-- Form buttons -->
                <div class="col-12 mt-4">
                    <div class="d-flex justify-content-between">
                        <a href="{{ path('app_etudiant_dashboard') }}" class="btn btn-secondary">
                            <i class="fas fa-times me-1"></i>Annuler
                        </a>
                        <div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-1"></i>Enregistrer les modifications
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {{ form_end(form) }}
        </div>
    </div>
    <!-- Edit profile form END -->

    <!-- Account Information Card -->
    <div class="card border bg-transparent rounded-3 mt-4">
        <div class="card-header bg-transparent border-bottom">
            <h3 class="mb-0">Informations du compte</h3>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <ul class="list-group list-group-borderless">
                        <li class="list-group-item d-flex justify-content-between">
                            <span><i class="fas fa-user-plus me-2"></i>Date de création</span>
                            <span class="fw-bold">{{ student.dateCreation|date('d/m/Y') }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span><i class="fas fa-sign-in-alt me-2"></i>Dernière connexion</span>
                            <span class="fw-bold">
                                {% if student.lastLogin %}
                                    {{ student.lastLogin|date('d/m/Y H:i') }}
                                {% else %}
                                    Jamais connecté
                                {% endif %}
                            </span>
                        </li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <ul class="list-group list-group-borderless">
                        <li class="list-group-item d-flex justify-content-between">
                            <span><i class="fas fa-shield-alt me-2"></i>Sécurité du compte</span>
                            <span class="badge bg-success">Actif</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span><i class="fas fa-envelope me-2"></i>Notifications</span>
                            <span class="badge bg-primary">Activées</span>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="row mt-4">
                <div class="col-12">
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ path('app_etudiant_change_password') }}" class="btn btn-outline-warning">
                            <i class="fas fa-key me-1"></i>Changer le mot de passe
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        // Avatar upload preview
        document.getElementById('avatarUpload')?.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const avatarDiv = document.querySelector('.avatar-img');
                    avatarDiv.innerHTML = `<img src="${e.target.result}" alt="Avatar" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
                }
                reader.readAsDataURL(file);
            }
        });

        // Form validation
        document.getElementById('editProfileForm')?.addEventListener('submit', function(e) {
            const email = document.getElementById('{{ form.email.vars.id }}').value;
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

            if (!emailRegex.test(email)) {
                e.preventDefault();
                alert('Veuillez entrer une adresse email valide.');
                return false;
            }

            return true;
        });
    </script>
{% endblock %}